#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "driver/twai.h"
#include "esp_log.h"

#define HEARTBEAT_LED GPIO_NUM_21
#define HEARTBEAT_INTERVAL_MS 500

#define TX_GPIO_NUM 11
#define RX_GPIO_NUM 10

#define PIN_SR_CLK    GPIO_NUM_4
#define PIN_SR_DATA   GPIO_NUM_7
#define PIN_SR_LATCH1 GPIO_NUM_5
#define PIN_SR_LATCH2 GPIO_NUM_6

static const char *TAG = "CAN_ID";

static uint8_t seg_reg_state = 0xFF;  
static uint8_t out_reg_state = 0x00;  

static const uint8_t SevenSegPatterns[11] = {
    0b11000000, 0b11111001, 0b10100100, 0b10110000, 0b10011001,
    0b10010010, 0b10000010, 0b11111000, 0b10000000, 0b10010000,
    0b11111111
};

static void shiftOut16(uint16_t combined_value, bool latch1, bool latch2) {
    for (int i = 15; i >= 0; --i) {
        uint8_t bit_val = (combined_value >> i) & 0x1;
        gpio_set_level(PIN_SR_DATA, bit_val);
        gpio_set_level(PIN_SR_CLK, 1);
        gpio_set_level(PIN_SR_CLK, 0);
    }
    if (latch1) { gpio_set_level(PIN_SR_LATCH1, 1); gpio_set_level(PIN_SR_LATCH1, 0); }
    if (latch2) { gpio_set_level(PIN_SR_LATCH2, 1); gpio_set_level(PIN_SR_LATCH2, 0); }
}

void SevenSegment(int number) {
    if (number < 0 || number > 10) return;
    seg_reg_state = SevenSegPatterns[number];
    //(közös anód, LOW=OFF, HIGH=ON)
   seg_reg_state = ~SevenSegPatterns[number] & 0xFF;
    uint16_t combined = ((uint16_t)seg_reg_state << 8) | out_reg_state;
    shiftOut16(combined, false, true);
}

void setup_gpio() {
    gpio_reset_pin(HEARTBEAT_LED);
    gpio_set_direction(HEARTBEAT_LED, GPIO_MODE_OUTPUT);

    gpio_reset_pin(PIN_SR_CLK);
    gpio_set_direction(PIN_SR_CLK, GPIO_MODE_OUTPUT);

    gpio_reset_pin(PIN_SR_DATA);
    gpio_set_direction(PIN_SR_DATA, GPIO_MODE_OUTPUT);

    gpio_reset_pin(PIN_SR_LATCH1);
    gpio_set_direction(PIN_SR_LATCH1, GPIO_MODE_OUTPUT);

    gpio_reset_pin(PIN_SR_LATCH2);
    gpio_set_direction(PIN_SR_LATCH2, GPIO_MODE_OUTPUT);
}

void CAN_Init() {
    twai_general_config_t g_config = TWAI_GENERAL_CONFIG_DEFAULT(TX_GPIO_NUM, RX_GPIO_NUM, TWAI_MODE_NORMAL);
    twai_timing_config_t t_config = TWAI_TIMING_CONFIG_500KBITS();
    twai_filter_config_t f_config = TWAI_FILTER_CONFIG_ACCEPT_ALL();
    if (twai_driver_install(&g_config, &t_config, &f_config) == ESP_OK) {
        twai_start();
        ESP_LOGI(TAG, "CAN initialized");
    }
}

void app_main(void)
{
    bool heartbeat_state = false;
    setup_gpio();
    CAN_Init();

    SevenSegment(5); // ide írod milyen számot akarsz látni

    twai_message_t msg = {
        .identifier = 0x101,
        .extd = 0,
        .rtr = 0,
        .data_length_code = 1,
        .data = {1}
    };

    while (1) {
        heartbeat_state = !heartbeat_state;
        gpio_set_level(HEARTBEAT_LED, heartbeat_state);

        if (twai_transmit(&msg, pdMS_TO_TICKS(100)) == ESP_OK) {
            ESP_LOGI(TAG, "Sent CAN ID 5"); //ide írod a logot
        }

        vTaskDelay(pdMS_TO_TICKS(HEARTBEAT_INTERVAL_MS));
    }
}
